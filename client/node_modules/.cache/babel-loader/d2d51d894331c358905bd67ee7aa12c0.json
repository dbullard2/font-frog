{"ast":null,"code":"/**\n * Apply Arabic presentation forms to a range of tokens\n */\nimport { ContextParams } from '../../tokenizer';\nimport { isIsolatedArabicChar, isTashkeelArabicChar } from '../../char';\nimport { SubstitutionAction } from '../featureQuery';\nimport applySubstitution from '../applySubstitution';\n/**\n * Check if a char can be connected to it's preceding char\n * @param {ContextParams} charContextParams context params of a char\n */\n\nfunction willConnectPrev(charContextParams) {\n  var backtrack = [].concat(charContextParams.backtrack);\n\n  for (var i = backtrack.length - 1; i >= 0; i--) {\n    var prevChar = backtrack[i];\n    var isolated = isIsolatedArabicChar(prevChar);\n    var tashkeel = isTashkeelArabicChar(prevChar);\n    if (!isolated && !tashkeel) return true;\n    if (isolated) return false;\n  }\n\n  return false;\n}\n/**\n * Check if a char can be connected to it's proceeding char\n * @param {ContextParams} charContextParams context params of a char\n */\n\n\nfunction willConnectNext(charContextParams) {\n  if (isIsolatedArabicChar(charContextParams.current)) return false;\n\n  for (var i = 0; i < charContextParams.lookahead.length; i++) {\n    var nextChar = charContextParams.lookahead[i];\n    var tashkeel = isTashkeelArabicChar(nextChar);\n    if (!tashkeel) return true;\n  }\n\n  return false;\n}\n/**\n * Apply arabic presentation forms to a list of tokens\n * @param {ContextRange} range a range of tokens\n */\n\n\nfunction arabicPresentationForms(range) {\n  var _this = this;\n\n  var script = 'arab';\n  var tags = this.featuresTags[script];\n  var tokens = this.tokenizer.getRangeTokens(range);\n  if (tokens.length === 1) return;\n  var contextParams = new ContextParams(tokens.map(function (token) {\n    return token.getState('glyphIndex');\n  }), 0);\n  var charContextParams = new ContextParams(tokens.map(function (token) {\n    return token.char;\n  }), 0);\n  tokens.forEach(function (token, index) {\n    if (isTashkeelArabicChar(token.char)) return;\n    contextParams.setCurrentIndex(index);\n    charContextParams.setCurrentIndex(index);\n    var CONNECT = 0; // 2 bits 00 (10: can connect next) (01: can connect prev)\n\n    if (willConnectPrev(charContextParams)) CONNECT |= 1;\n    if (willConnectNext(charContextParams)) CONNECT |= 2;\n    var tag;\n\n    switch (CONNECT) {\n      case 1:\n        tag = 'fina';\n        break;\n\n      case 2:\n        tag = 'init';\n        break;\n\n      case 3:\n        tag = 'medi';\n        break;\n    }\n\n    if (tags.indexOf(tag) === -1) return;\n\n    var substitutions = _this.query.lookupFeature({\n      tag: tag,\n      script: script,\n      contextParams: contextParams\n    });\n\n    if (substitutions instanceof Error) return console.info(substitutions.message);\n    substitutions.forEach(function (action, index) {\n      if (action instanceof SubstitutionAction) {\n        applySubstitution(action, tokens, index);\n        contextParams.context[index] = action.substitution;\n      }\n    });\n  });\n}\n\nexport default arabicPresentationForms;\nexport { arabicPresentationForms };","map":null,"metadata":{},"sourceType":"module"}