{"ast":null,"code":"/**\n * Infer bidirectional properties for a given text and apply\n * the corresponding layout rules.\n */\nimport Tokenizer from './tokenizer';\nimport FeatureQuery from './features/featureQuery';\nimport arabicWordCheck from './features/arab/contextCheck/arabicWord';\nimport arabicSentenceCheck from './features/arab/contextCheck/arabicSentence';\nimport arabicPresentationForms from './features/arab/arabicPresentationForms';\nimport arabicRequiredLigatures from './features/arab/arabicRequiredLigatures';\nimport latinWordCheck from './features/latn/contextCheck/latinWord';\nimport latinLigature from './features/latn/latinLigatures';\n/**\n * Create Bidi. features\n * @param {string} baseDir text base direction. value either 'ltr' or 'rtl'\n */\n\nfunction Bidi(baseDir) {\n  this.baseDir = baseDir || 'ltr';\n  this.tokenizer = new Tokenizer();\n  this.featuresTags = {};\n}\n/**\n * Sets Bidi text\n * @param {string} text a text input\n */\n\n\nBidi.prototype.setText = function (text) {\n  this.text = text;\n};\n/**\n * Store essential context checks:\n * arabic word check for applying gsub features\n * arabic sentence check for adjusting arabic layout\n */\n\n\nBidi.prototype.contextChecks = {\n  latinWordCheck: latinWordCheck,\n  arabicWordCheck: arabicWordCheck,\n  arabicSentenceCheck: arabicSentenceCheck\n};\n/**\n * Register arabic word check\n */\n\nfunction registerContextChecker(checkId) {\n  var check = this.contextChecks[\"\".concat(checkId, \"Check\")];\n  return this.tokenizer.registerContextChecker(checkId, check.startCheck, check.endCheck);\n}\n/**\n * Perform pre tokenization procedure then\n * tokenize text input\n */\n\n\nfunction tokenizeText() {\n  registerContextChecker.call(this, 'latinWord');\n  registerContextChecker.call(this, 'arabicWord');\n  registerContextChecker.call(this, 'arabicSentence');\n  return this.tokenizer.tokenize(this.text);\n}\n/**\n * Reverse arabic sentence layout\n * TODO: check base dir before applying adjustments - priority low\n */\n\n\nfunction reverseArabicSentences() {\n  var _this = this;\n\n  var ranges = this.tokenizer.getContextRanges('arabicSentence');\n  ranges.forEach(function (range) {\n    var rangeTokens = _this.tokenizer.getRangeTokens(range);\n\n    _this.tokenizer.replaceRange(range.startIndex, range.endOffset, rangeTokens.reverse());\n  });\n}\n/**\n * Register supported features tags\n * @param {script} script script tag\n * @param {Array} tags features tags list\n */\n\n\nBidi.prototype.registerFeatures = function (script, tags) {\n  var _this2 = this;\n\n  var supportedTags = tags.filter(function (tag) {\n    return _this2.query.supports({\n      script: script,\n      tag: tag\n    });\n  });\n\n  if (!this.featuresTags.hasOwnProperty(script)) {\n    this.featuresTags[script] = supportedTags;\n  } else {\n    this.featuresTags[script] = this.featuresTags[script].concat(supportedTags);\n  }\n};\n/**\n * Apply GSUB features\n * @param {Array} tagsList a list of features tags\n * @param {string} script a script tag\n * @param {Font} font opentype font instance\n */\n\n\nBidi.prototype.applyFeatures = function (font, features) {\n  if (!font) throw new Error('No valid font was provided to apply features');\n  if (!this.query) this.query = new FeatureQuery(font);\n\n  for (var f = 0; f < features.length; f++) {\n    var feature = features[f];\n    if (!this.query.supports({\n      script: feature.script\n    })) continue;\n    this.registerFeatures(feature.script, feature.tags);\n  }\n};\n/**\n * Register a state modifier\n * @param {string} modifierId state modifier id\n * @param {function} condition a predicate function that returns true or false\n * @param {function} modifier a modifier function to set token state\n */\n\n\nBidi.prototype.registerModifier = function (modifierId, condition, modifier) {\n  this.tokenizer.registerModifier(modifierId, condition, modifier);\n};\n/**\n * Check if 'glyphIndex' is registered\n */\n\n\nfunction checkGlyphIndexStatus() {\n  if (this.tokenizer.registeredModifiers.indexOf('glyphIndex') === -1) {\n    throw new Error('glyphIndex modifier is required to apply ' + 'arabic presentation features.');\n  }\n}\n/**\n * Apply arabic presentation forms features\n */\n\n\nfunction applyArabicPresentationForms() {\n  var _this3 = this;\n\n  var script = 'arab';\n  if (!this.featuresTags.hasOwnProperty(script)) return;\n  checkGlyphIndexStatus.call(this);\n  var ranges = this.tokenizer.getContextRanges('arabicWord');\n  ranges.forEach(function (range) {\n    arabicPresentationForms.call(_this3, range);\n  });\n}\n/**\n * Apply required arabic ligatures\n */\n\n\nfunction applyArabicRequireLigatures() {\n  var _this4 = this;\n\n  var script = 'arab';\n  if (!this.featuresTags.hasOwnProperty(script)) return;\n  var tags = this.featuresTags[script];\n  if (tags.indexOf('rlig') === -1) return;\n  checkGlyphIndexStatus.call(this);\n  var ranges = this.tokenizer.getContextRanges('arabicWord');\n  ranges.forEach(function (range) {\n    arabicRequiredLigatures.call(_this4, range);\n  });\n}\n/**\n * Apply required arabic ligatures\n */\n\n\nfunction applyLatinLigatures() {\n  var _this5 = this;\n\n  var script = 'latn';\n  if (!this.featuresTags.hasOwnProperty(script)) return;\n  var tags = this.featuresTags[script];\n  if (tags.indexOf('liga') === -1) return;\n  checkGlyphIndexStatus.call(this);\n  var ranges = this.tokenizer.getContextRanges('latinWord');\n  ranges.forEach(function (range) {\n    latinLigature.call(_this5, range);\n  });\n}\n/**\n * Check if a context is registered\n * @param {string} contextId context id\n */\n\n\nBidi.prototype.checkContextReady = function (contextId) {\n  return !!this.tokenizer.getContext(contextId);\n};\n/**\n * Apply features to registered contexts\n */\n\n\nBidi.prototype.applyFeaturesToContexts = function () {\n  if (this.checkContextReady('arabicWord')) {\n    applyArabicPresentationForms.call(this);\n    applyArabicRequireLigatures.call(this);\n  }\n\n  if (this.checkContextReady('latinWord')) {\n    applyLatinLigatures.call(this);\n  }\n\n  if (this.checkContextReady('arabicSentence')) {\n    reverseArabicSentences.call(this);\n  }\n};\n/**\n * process text input\n * @param {string} text an input text\n */\n\n\nBidi.prototype.processText = function (text) {\n  if (!this.text || this.text !== text) {\n    this.setText(text);\n    tokenizeText.call(this);\n    this.applyFeaturesToContexts();\n  }\n};\n/**\n * Process a string of text to identify and adjust\n * bidirectional text entities.\n * @param {string} text input text\n */\n\n\nBidi.prototype.getBidiText = function (text) {\n  this.processText(text);\n  return this.tokenizer.getText();\n};\n/**\n * Get the current state index of each token\n * @param {text} text an input text\n */\n\n\nBidi.prototype.getTextGlyphs = function (text) {\n  this.processText(text);\n  var indexes = [];\n\n  for (var i = 0; i < this.tokenizer.tokens.length; i++) {\n    var token = this.tokenizer.tokens[i];\n    if (token.state.deleted) continue;\n    var index = token.activeState.value;\n    indexes.push(Array.isArray(index) ? index[0] : index);\n  }\n\n  return indexes;\n};\n\nexport default Bidi;","map":null,"metadata":{},"sourceType":"module"}